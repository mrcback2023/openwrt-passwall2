name: Build OpenWrt 23.05.5 + Passwall2 for WRT3200ACM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MAKEFLAGS: "-j2"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ccache git libssl-dev python3 python3-distutils \
             gcc g++ zlib1g-dev subversion libncurses5-dev unzip file wget curl

      - name: Clone OpenWrt 23.05.5
        run: |
          git clone -b openwrt-23.05 https://git.openwrt.org/openwrt/openwrt.git openwrt-src
          cd openwrt-src
          git fetch --all --tags
          git checkout v23.05.5 || true

      - name: Add Passwall2 feed and update feeds
        run: |
          cd openwrt-src
          cat > feeds.conf << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
src-git telephony https://git.openwrt.org/feed/telephony.git
src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git
EOF
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Prepare build config
        run: |
          cd openwrt-src
          make defconfig
          cat >> .config << 'EOF'
CONFIG_TARGET_mvebu=y
CONFIG_TARGET_mvebu_cortexa9=y
CONFIG_TARGET_mvebu_cortexa9_DEVICE_linksys_wrt3200acm=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl=y
CONFIG_PACKAGE_luci-app-passwall2=y
CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_sing-box=y
CONFIG_PACKAGE_hysteria=y
CONFIG_PACKAGE_dns2socks=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_wget=y
EOF

      - name: Build firmware
        run: |
          cd openwrt-src
          make -j2 V=s

      - name: Upload built firmware
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-passwall2-wrt3200acm
          path: openwrt-src/bin/targets/mvebu/cortexa9/
