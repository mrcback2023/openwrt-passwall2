name: Build OpenWrt-Passwall2-WRT3200ACM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk \
        gettext git libncurses5-dev libssl-dev python3-distutils \
        python3-pip rsync unzip zlib1g-dev file wget curl

    - name: Clone OpenWrt
      run: |
        git clone https://github.com/openwrt/openwrt.git
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Add Passwall2 Feed
      run: |
        cd openwrt/package
        git clone https://github.com/mrcback2023/openwrt-passwall2.git
        cd ..

    - name: Update Feeds Again
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Inject Custom .config
      run: |
        cd openwrt
        cat << "EOF" > .config
CONFIG_TARGET_mvebu=y
CONFIG_TARGET_mvebu_cortexa9=y
CONFIG_TARGET_mvebu_cortexa9_DEVICE_linksys_wrt3200acm=y

CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-ssl=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-theme-bootstrap=y

CONFIG_PACKAGE_dnsmasq-full=y
CONFIG_PACKAGE_ipset=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_iptables-mod-tproxy=y

CONFIG_PACKAGE_luci-app-passwall2=y
CONFIG_PACKAGE_passwall2=y
CONFIG_PACKAGE_passwall2-core=y
CONFIG_PACKAGE_passwall2-geodata=y

CONFIG_PACKAGE_xray-core=y
CONFIG_PACKAGE_xray-geodata=y
CONFIG_PACKAGE_sing-box=y
CONFIG_PACKAGE_hysteria=y
CONFIG_PACKAGE_v2ray-core=y
CONFIG_PACKAGE_naiveproxy=y
CONFIG_PACKAGE_trojan-go=y
CONFIG_PACKAGE_trojan-plus=y
CONFIG_PACKAGE_microsocks=y

CONFIG_PACKAGE_kmod-mwlwifi=y
CONFIG_PACKAGE_mwlwifi-firmware-88w8964=y

CONFIG_PACKAGE_ca-certificates=y
CONFIG_PACKAGE_wget-ssl=y
EOF

        make defconfig

    - name: Download Sources
      run: |
        cd openwrt
        make download -j8

    - name: Build Firmware
      run: |
        cd openwrt
        make -j$(nproc) || make -j1 V=s

    - name: Upload Firmware
      uses: actions/upload-artifact@v3
      with:
        name: OpenWrt-Passwall2-WRT3200ACM
        path: openwrt/bin/targets/
